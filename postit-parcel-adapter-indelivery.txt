

async function dpCreate() {

if (!(await existsStateAsync("0_userdata.0.Alarm-MaterialDesign.DeliveryPostitReminder"))) {
        await createStateAsync("0_userdata.0.Alarm-MaterialDesign.DeliveryPostitReminder",'[{"id":"PostReminderArray","deleter":""}]',{type: "string", name: "DeliveryPostitReminder", role: "value", read: true, write: true, } ); }
}

dpCreate();

schedule("  * * * * *", async function () {

let myOldDeliveryJSON=JSON.parse(getState('0_userdata.0.Alarm-MaterialDesign.DeliveryPostitReminder').val)
 log(JSON.stringify(myOldDeliveryJSON))
let deliveryJSON=JSON.parse(getState('parcel.0.inDelivery').val)

let isAlready=false;
   if (deliveryJSON.length>0){
    for(let i=0;i<deliveryJSON.length;i++){
         isAlready=false;
         for (let ii=0;ii<myOldDeliveryJSON.length;ii++){
             if (myOldDeliveryJSON[ii].id==deliveryJSON[i].id) isAlready=true;
         }
    
         if(!isAlready) { myOldDeliveryJSON.push({"id":deliveryJSON[i].id,"deleter":deliveryJSON[i].source+' Paket kommt heute von '+deliveryJSON[i].name}) ;
         log('ii')
         setState('0_userdata.0.Alarm-MaterialDesign.PostItErstellen',deliveryJSON[i].source+" Paket kommt heute von "+deliveryJSON[i].name)
         } else{  }
   }
}
  
 setTimeout(async function () {


let isMissing=false;
let toDelArr=[]; 
   if (myOldDeliveryJSON.length>1){
       for (let ii=1;ii<myOldDeliveryJSON.length;ii++){
   
         isMissing=false;
          for(let i=0;i<deliveryJSON.length;i++){
             if (myOldDeliveryJSON[ii].id==deliveryJSON[i].id) isMissing=true;
         }
    
         if(!isMissing) { toDelArr.push(ii);//log(" in array "+ii)
                          
                          setState('0_userdata.0.Alarm-MaterialDesign.PostItDelete',myOldDeliveryJSON[ii].deleter)
         } 
   }
}
    //   log("lÃ¤nge: "+toDelArr.length.toString()+" und "+JSON.stringify(myOldDeliveryJSON))
       if(toDelArr.length>0){ for (let iii=toDelArr.length-1 ;  iii>=0; iii--){ //log(toDelArr[iii].toString())
                                                        myOldDeliveryJSON.splice(iii+1,1)
                          }}
//log(JSON.stringify(myOldDeliveryJSON))
setState('0_userdata.0.Alarm-MaterialDesign.DeliveryPostitReminder', JSON.stringify(myOldDeliveryJSON));
}, 3000);
});




